<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./StyleGraphe.css">
    <title>Graphe 3</title>
</head>
<body>
    

    <div class="acceuil">
        <div class="img">
                <img src="./Images/DataWood.svg" alt="DataWood">
        </div>
        <div class="corp">
            
            <div class="gauche">    
                <div class="btn">
                    <a class="Retour" href="./choixGraphe.html">
                    <img src="./Images/Arrow 1.svg" alt="back">
                        Retour
                    </a>
                </div>
                <div class="PlusPopulaire">
                    <img src="./Images/N3.svg" alt="N1">
                    <h1>
                        Les films au bugdet le plus haut.
                    </h1>
                    <p>
                        Lorem ipsum dolor sit amet consectetur, adipisicing elit. Perspiciatis, minima accusamus. Impedit magnam error eius, deserunt consequatur, libero qui aperiam eveniet tenetur provident, soluta veritatis 
                    </p>
                </div>
            </div>
            <div class="droite">
                <canvas id="budget-chart" width="400" height="400"></canvas>
            </div>
        </div>
    </div>


    <script>
        const apiKey = 'f419f1613639c532f9f464ad9e648767';
        function fetchMoviesByBudget() {
            fetch(`https://api.themoviedb.org/3/discover/movie?api_key=${apiKey}&sort_by=popularity.desc&language=fr-FR&page=1`)
                .then(response => response.json())
                .then(data => {
                    const movies = data.results.slice(0, 15); // Limite à 15 films
                    const moviesWithBudgets = [];

                    const budgetPromises = movies.map(movie =>
                        fetch(`https://api.themoviedb.org/3/movie/${movie.id}?api_key=${apiKey}`)
                            .then(response => response.json())
                            .then(details => {
                                if (details.budget > 0) {
                                    // Si le film a un budget valide, on l'ajoute à la liste
                                    moviesWithBudgets.push({
                                        title: movie.title,
                                        budget: details.budget
                                    });
                                }
                            })
                    );

                    // Quand tous les films ont été récupérés
                    Promise.all(budgetPromises).then(() => {
                        // Vérifie si nous avons moins de 15 films avec un budget valide
                        if (moviesWithBudgets.length < 15) {
                            // Si moins de 15 films, on récupère des films avec les plus gros budgets
                            fetch(`https://api.themoviedb.org/3/discover/movie?api_key=${apiKey}&sort_by=budget.desc&language=fr-FR&page=1`)
                                .then(response => response.json())
                                .then(data => {
                                    const additionalMovies = data.results.slice(0, 15 - moviesWithBudgets.length);
                                    additionalMovies.forEach(movie => {
                                        fetch(`https://api.themoviedb.org/3/movie/${movie.id}?api_key=${apiKey}`)
                                            .then(response => response.json())
                                            .then(details => {
                                                if (details.budget > 0) {
                                                    moviesWithBudgets.push({
                                                        title: movie.title,
                                                        budget: details.budget
                                                    });
                                                }
                                            });
                                    });
                                });
                        }

                        // Une fois tous les films récupérés, on met à jour le graphique
                        Promise.all(budgetPromises).then(() => updateBudgetChart(moviesWithBudgets));
                    });
                })
                .catch(error => {
                    console.error('Erreur lors de la récupération des films:', error);
                    document.querySelector('.droite').innerHTML = `<p>Erreur: ${error.message}. Vérifiez votre connexion ou réessayez plus tard.</p>`;
                });
        }




        function updateBudgetChart(movies) {
            const topMovies = movies.slice(0, 10); // Obtenir les 10 films avec le budget le plus élevé
            const labels = topMovies.map(movie => movie.title);
            const data = topMovies.map(movie => movie.budget);

            const ctx = document.getElementById('budget-chart').getContext('2d');
            if (window.budgetChart) {
                window.budgetChart.destroy();
            }

            window.budgetChart = new Chart(ctx, {
                type: 'bubble',
                data: {
                    datasets: data.map((budget, index) => ({
                        label: labels[index],
                        data: [{ x: index, y: budget, r: Math.sqrt(budget / 1000000) * 2 }], // Multipliez par un facteur (par exemple 2) pour augmenter la taille
                        backgroundColor: `rgba(${Math.random() * 255}, ${Math.random() * 255}, ${Math.random() * 255}, 0.6)`
                    }))
                },
                options: {
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.raw.y.toLocaleString()} $`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: { display: false },
                        y: { beginAtZero: true }
                    }
                }
            });
        }
        fetchMoviesByBudget();
    </script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
</body>
</html>